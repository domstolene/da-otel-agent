<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{base}">

<head>
    <title>Agent Configuration</title>
    <style>
        label {
            font-weight: bold;
        }

        .form-control {
            display: inline;
            width: 300px;
        }

        form div {
            margin-bottom: 1rem;
        }
    </style>
    <script>

        function updateConfig() {
            
            throw Error;
        }

        document.addEventListener('DOMContentLoaded', () => {

            const toastElList = document.querySelectorAll('.toast')
            const toastList = [...toastElList].map(toastEl => new bootstrap.Toast(toastEl, {}));
            const form = document.querySelector('form');
            const successToast = document.getElementById('successToast');
            const errorToast = document.getElementById('errorToast');

            form.addEventListener('submit', (event) => {
                event.preventDefault();
                let activeToast = null;


                try {
                    updateConfig();
                    activeToast = bootstrap.Toast.getOrCreateInstance(successToast);
                }
                catch {
                    console.log("Failed")
                    activeToast = bootstrap.Toast.getOrCreateInstance(errorToast);
                }

                activeToast.show();



            });
        });
    </script>
</head>

<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <h1 th:text="${name}"></h1>
            <hr>
            <p><b>Read Only:</b> <span th:text="${config.readOnly}">false</span></p>
            <p><b>Last changed:</b> <span
                    th:text="${#dates.format(config.timestamp, 'yyyy-MM-dd HH:mm:ss')}">Timestamp</span></p>
            <div>
                <form>

                    <div>
                        <label for="sampler">Sampler: </label>
                        <select class="form-select form-control" id="sampler" th:disabled="${config.readOnly}"
                            th:name="sampler">
                            <option
                                th:each="samplerType : ${T(no.domstol.otel.agent.service.AgentConfiguration.SamplerType).values()}"
                                th:value="${samplerType}" th:text="${samplerType}"
                                th:selected="${config.sampler == samplerType}">
                            </option>
                        </select>
                    </div>

                    <div>
                        <label for="ratio">Sample ratio:</label>
                        <input type="number" step="0.001" min="0" max="1" id="ratio" class="form-control"
                            th:name="sampleRatio" th:value="${config.sampleRatio}" th:disabled="${config.readOnly}" />
                    </div>

                    <div>
                        <label style="display: block;" for="rules-textarea" class="form-label">Rules:</label>
                        <textarea id="rules-textarea" class="form-control" rows="10"
                            th:text="${@configurationRenderer.getFormattedRules(config)}"></textarea>
                        <p th:if="${config.rules == null}">No rules defined.</p>
                    </div>

                    <button type="submit" id="saveBtn" th:disabled="${config.readOnly}" class="btn btn-primary"><i
                            class="bi bi-floppy-fill"></i> Save
                        agent configuration</button>
                </form>
            </div>
        </div>
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="successToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header text-bg-success">
                    <strong class="me-auto">Saved!</strong>
                    <button type="button" class="btn-close btn-close-white border-0" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    <p th:text="${name} + ' configuration updated!'"></p>
                </div>
            </div>
            <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header text-bg-danger">
                    <strong class="me-auto">Error!</strong>
                    <button type="button" class="btn-close btn-close-white border-0" data-bs-dismiss="toast"
                        aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    <p th:text="${name} + ' configuration could not be updated!'"></p>
                </div>
            </div>
        </div>
    </div>
</body>